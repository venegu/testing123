<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
    	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    	<meta name="viewport" content="width=device-width, initial-scale=1">
    	<meta name="description" content="HTML Bones for Chatapp">
   		<meta name="author" content="Lisa Maldonado">

   		<title>Vitanao - The Thing with "Nao"</title>

    	<!-- Bootstrap Core CSS -->
    	<link href="css/bootstrap.min.css" rel="stylesheet">

    	<!-- Custom CSS -->
    	<link href="css/main.css" rel="stylesheet">

    	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    	<!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    	<![endif]-->

	</head>
    <body>
            <div class="chat">
                <!-- where you can input name -->
                <input type="text" class="c-name" placeholder="Now, what did you say your name was?">
                <div class="c-messages"></div>
                <!-- where you input your message -->
                <textarea class="c-textarea" placeholder="Enter profanity here."></textarea>
                <!-- online status of sorts -->
                <div class="c-status">Condition: <span>Bumming</span></div>
            </div> <!-- closing chat class -->
            <!-- Connecting to Nodejs Server and serving socket.io files with server ip -->
            <script src="http://127.0.0.1:8080/socket.io/socket.io.js"></script> <!-- server end -->

            <script>
                (function () {
                    var getNode = function(s) {
                        return document.querySelector(s);
                    },
                    /* Get required nodes */
                    textarea = getNode('.c-textarea'),
                    chatName = getNode('.c-name'),
                    messages = getNode('.c-messages'),
                    status = getNode('span'),

                    statusDef = status.textContent,
                    setStatus = function(s) {
                        status.textContent = s;

                        if(s !== statusDef) {
                            var delay = setTimeout(function(){
                                setStatus(statusDef);
                                clearInterval(delay);
                            }, 2500);
                        }
                    };
                    //setStatus('Testing');

                    try {
                        var socket = io.connect('http://127.0.0.1:8080')
                    }
                    catch (e) {
                        /* set status to warn user */
                    }

                    if(socket !== undefined) {
                        /* Listen for output */
                        socket.on('output', function(data){
                            //console.log(data);
                            if(data.length) {
                                for(var x = 0; x < data.length; x = x + 1){
                                    /* looping through count of messages */
                                    var message = document.createElement('div');
                                    message.setAttribute('class', 'c-message');
                                    message.textContent = data[x].name + ': ' + data[x].message;

                                    messages.appendChild(message);
                                    /* Inserting in reverse order */
                                   // messages.insertBefore(message, messages.firstChild);
                                }
                            }
                        });

                        /* Listen for status */
                        socket.on('status', function(data) {
                            setStatus((typeof data === 'object') ? data.message : data);

                            if(data.clear === true) {
                                textarea.value = '';
                            }
                        });

                        /* Listen for keydown */
                        textarea.addEventListener('keydown', function(event) {
                            var self = this;
                            var name = chatName.value;

                            //console.log(event.which); /* which key is pressed down */
                            /* 13 == enter key */
                            /* 32 == shit key */

                            /* Mulitple lines in the textarea */
                            if(event.which === 13 && event.shiftKey === false) {
                                //console.log('Send!');
                                socket.emit('input', {name: name, message: self.value});
                                event.preventDefault();
                            }
                        });
                    }
                })();
            </script>
        </body>
</html>